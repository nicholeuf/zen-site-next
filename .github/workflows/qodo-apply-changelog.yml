name: Qodo Apply Changelog

on:
  workflow_run:
    workflows: ['Qodo Generate Changelog']
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-changelog:
    # This workflow runs in a trusted context with write permissions
    runs-on: ubuntu-latest
    # Security: Only run if the triggering workflow was successful AND from a legitimate PR
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.pull_requests != null && github.event.workflow_run.pull_requests.length > 0
    steps:
      - name: Debug workflow run info
        run: |
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run status: ${{ github.event.workflow_run.status }}"
          echo "Workflow run name: ${{ github.event.workflow_run.name }}"
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download changelog artifact
        uses: actions/download-artifact@v4
        with:
          name: CHANGELOG.md
          path: .

      - name: Apply changelog update
        run: |
          echo "PR head branch: $PR_HEAD_REF"
          echo "PR head SHA: $PR_HEAD_SHA"

          # Security: Verify this is a legitimate PR workflow
          if [ -z "$PR_HEAD_REF" ] || [ -z "$PR_HEAD_SHA" ]; then
            echo "‚ùå Security check failed: Missing PR information"
            exit 1
          fi

          # Security: Verify the PR is not from a fork (additional check)
          if [ "$PR_IS_FORK" = "true" ]; then
            echo "‚ùå Security check failed: PR is from a fork"
            exit 1
          fi

          # Check if changelog file exists
          if [ -f "./CHANGELOG.md" ]; then
            echo "Changelog file found, checking for changes..."
            
            # Check if there are any changes to commit
            if git diff --quiet CHANGELOG.md; then
              echo "‚ÑπÔ∏è No changes detected in CHANGELOG.md"
              echo "Skipping commit as no changes were made"
            else
              echo "üìù Changes detected in CHANGELOG.md"
              
              # Commit and push the changes to the current branch
              git config --local user.email "noreply@github.com"
              git config --local user.name "Qodo Changelog Bot"
              git add CHANGELOG.md
              git commit -m "Update CHANGELOG.md [skip ci]"
              git push origin "$PR_HEAD_REF"
              
              echo "‚úÖ Changelog updated successfully on PR head branch: $PR_HEAD_REF"
            fi
          else
            echo "‚ùå No CHANGELOG.md file found in artifact"
            exit 1
          fi
        env:
          PR_HEAD_REF: ${{ github.event.workflow_run.head_branch }}
          PR_HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          PR_IS_FORK: ${{ github.event.workflow_run.pull_requests[0].head.repo.fork }}

      - name: Comment on PR
        run: |
          gh pr comment "$PR_URL" --body "‚úÖ Changelog has been updated automatically"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.workflow_run.pull_requests[0].html_url }}
