name: Qodo Apply Changelog

on:
  workflow_run:
    workflows: ['Qodo Generate Changelog']
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-changelog:
    # This workflow runs in a trusted context with write permissions
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download changelog artifact
        uses: actions/download-artifact@v4
        with:
          name: CHANGELOG.md
          path: ./CHANGELOG.md

      - name: Download PR URL artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-url
          path: ./pr-url

      - name: Apply changelog update
        run: |
          # Check if changelog file exists
          if [ -f "./CHANGELOG.md" ]; then
            echo "Changelog file found, checking for changes..."
            
            # Check if there are any changes to commit
            if git diff --quiet CHANGELOG.md; then
              echo "‚ÑπÔ∏è No changes detected in CHANGELOG.md"
              echo "Skipping commit as no changes were made"
            else
              echo "üìù Changes detected in CHANGELOG.md"
              
              # Commit and push the changes
              git config --local user.email "noreply@github.com"
              git config --local user.name "Qodo Changelog Bot"
              git add CHANGELOG.md
              git commit -m "Update CHANGELOG.md [skip ci]"
              git push
              
              echo "‚úÖ Changelog updated successfully"
            fi
          else
            echo "‚ùå No CHANGELOG.md file found in artifact"
            exit 1
          fi

      - name: Comment on PR
        run: |
          # Read PR URL from artifact
          if [ -f "./pr-url/pr_url.txt" ]; then
            PR_URL=$(cat ./pr-url/pr_url.txt)
            gh pr comment "$PR_URL" --body "‚úÖ Changelog has been updated automatically"
          else
            echo "Could not find PR URL in artifact"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
