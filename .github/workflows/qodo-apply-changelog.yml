name: Qodo Apply Changelog

on:
  repository_dispatch:
    types: [changelog-ready]
  workflow_dispatch:
    inputs:
      pr_url:
        description: 'PR URL'
        required: true
        type: string
      head_branch:
        description: 'PR head branch'
        required: true
        type: string
      head_sha:
        description: 'PR head SHA'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-changelog:
    # This workflow runs in a trusted context with write permissions
    runs-on: ubuntu-latest
    steps:
      - name: Debug trigger info
        run: |
          echo "Trigger type: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "Repository dispatch payload: ${{ toJson(github.event.client_payload) }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual dispatch inputs: ${{ toJson(github.event.inputs) }}"
          fi
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.head_sha || github.event.inputs.head_sha }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download changelog artifact
        uses: actions/download-artifact@v4
        with:
          name: CHANGELOG.md
          path: .

      - name: Apply changelog update
        run: |
          echo "PR head branch: $PR_HEAD_REF"
          echo "PR head SHA: $PR_HEAD_SHA"

          # Security: Verify this is a legitimate PR workflow
          if [ -z "$PR_HEAD_REF" ] || [ -z "$PR_HEAD_SHA" ]; then
            echo "‚ùå Security check failed: Missing PR information"
            exit 1
          fi

          # Security: Verify the PR is not from a fork (additional check)
          if [ "$PR_IS_FORK" = "true" ]; then
            echo "‚ùå Security check failed: PR is from a fork"
            exit 1
          fi

          # Check if changelog file exists
          if [ -f "./CHANGELOG.md" ]; then
            echo "Changelog file found, checking for changes..."
            
            # Check if there are any changes to commit
            if git diff --quiet CHANGELOG.md; then
              echo "‚ÑπÔ∏è No changes detected in CHANGELOG.md"
              echo "Skipping commit as no changes were made"
            else
              echo "üìù Changes detected in CHANGELOG.md"
              
              # Commit and push the changes to the current branch
              git config --local user.email "noreply@github.com"
              git config --local user.name "Qodo Changelog Bot"
              git add CHANGELOG.md
              git commit -m "Update CHANGELOG.md [skip ci]"
              git push origin "$PR_HEAD_REF"
              
              echo "‚úÖ Changelog updated successfully on PR head branch: $PR_HEAD_REF"
            fi
          else
            echo "‚ùå No CHANGELOG.md file found in artifact"
            exit 1
          fi
        env:
          PR_HEAD_REF: ${{ github.event.client_payload.head_branch || github.event.inputs.head_branch }}
          PR_HEAD_SHA: ${{ github.event.client_payload.head_sha || github.event.inputs.head_sha }}
          PR_URL: ${{ github.event.client_payload.pr_url || github.event.inputs.pr_url }}

      - name: Comment on PR
        run: |
          gh pr comment "$PR_URL" --body "‚úÖ Changelog has been updated automatically"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
