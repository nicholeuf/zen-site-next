name: Qodo Apply Changelog

on:
  workflow_run:
    workflows: ['Qodo Generate Changelog']
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-changelog:
    # This workflow runs in a trusted context with write permissions
    runs-on: ubuntu-latest
    # Temporarily removing success condition for debugging
    # if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Debug workflow run info
        run: |
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run status: ${{ github.event.workflow_run.status }}"
          echo "Workflow run name: ${{ github.event.workflow_run.name }}"
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download changelog artifact
        uses: actions/download-artifact@v4
        with:
          name: CHANGELOG.md
          path: .

      - name: Apply changelog update
        run: |
          # Get PR information from workflow_run context
          PR_HEAD_REF="${{ github.event.workflow_run.head_branch }}"
          PR_HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          echo "PR head branch: $PR_HEAD_REF"
          echo "PR head SHA: $PR_HEAD_SHA"

          # Check if changelog file exists
          if [ -f "./CHANGELOG.md" ]; then
            echo "Changelog file found, checking for changes..."
            
            # Check if there are any changes to commit
            if git diff --quiet CHANGELOG.md; then
              echo "‚ÑπÔ∏è No changes detected in CHANGELOG.md"
              echo "Skipping commit as no changes were made"
            else
              echo "üìù Changes detected in CHANGELOG.md"
              
              # Commit and push the changes to the current branch
              git config --local user.email "noreply@github.com"
              git config --local user.name "Qodo Changelog Bot"
              git add CHANGELOG.md
              git commit -m "Update CHANGELOG.md [skip ci]"
              git push origin "$PR_HEAD_REF"
              
              echo "‚úÖ Changelog updated successfully on PR head branch: $PR_HEAD_REF"
            fi
          else
            echo "‚ùå No CHANGELOG.md file found in artifact"
            exit 1
          fi

      - name: Comment on PR
        run: |
          # Get PR URL from workflow_run context
          PR_URL="${{ github.event.workflow_run.pull_requests[0].html_url }}"
          gh pr comment "$PR_URL" --body "‚úÖ Changelog has been updated automatically"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
