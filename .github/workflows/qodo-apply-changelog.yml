name: Qodo Apply Changelog

on:
  workflow_run:
    workflows: ['Qodo Generate Changelog']
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-changelog:
    # This workflow runs in a trusted context with write permissions
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Debug workflow run info
        run: |
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run status: ${{ github.event.workflow_run.status }}"
          echo "Workflow run name: ${{ github.event.workflow_run.name }}"
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download changelog artifact
        uses: actions/download-artifact@v4
        with:
          name: CHANGELOG.md
          path: ./CHANGELOG.md

      - name: Download GitHub event artifact
        uses: actions/download-artifact@v4
        with:
          name: github-event
          path: ./github-event

      - name: Apply changelog update
        run: |
          # Extract PR information from GitHub event
          if [ -f "./github-event/github_event.json" ]; then
            PR_HEAD_REF=$(jq -r '.pull_request.head.ref' ./github-event/github_event.json)
            PR_HEAD_SHA=$(jq -r '.pull_request.head.sha' ./github-event/github_event.json)
            echo "PR head branch: $PR_HEAD_REF"
            echo "PR head SHA: $PR_HEAD_SHA"
          else
            echo "‚ùå No GitHub event data found"
            exit 1
          fi

          # Check if changelog file exists
          if [ -f "./CHANGELOG.md" ]; then
            echo "Changelog file found, checking for changes..."
            
            # Checkout the PR's head branch
            git fetch origin "$PR_HEAD_REF"
            git checkout "$PR_HEAD_REF"
            
            # Check if there are any changes to commit
            if git diff --quiet CHANGELOG.md; then
              echo "‚ÑπÔ∏è No changes detected in CHANGELOG.md"
              echo "Skipping commit as no changes were made"
            else
              echo "üìù Changes detected in CHANGELOG.md"
              
              # Commit and push the changes to the PR's head branch
              git config --local user.email "noreply@github.com"
              git config --local user.name "Qodo Changelog Bot"
              git add CHANGELOG.md
              git commit -m "Update CHANGELOG.md [skip ci]"
              git push origin "$PR_HEAD_REF"
              
              echo "‚úÖ Changelog updated successfully on PR head branch: $PR_HEAD_REF"
            fi
          else
            echo "‚ùå No CHANGELOG.md file found in artifact"
            exit 1
          fi

      - name: Comment on PR
        run: |
          # Extract PR URL from GitHub event
          if [ -f "./github-event/github_event.json" ]; then
            PR_URL=$(jq -r '.pull_request.html_url' ./github-event/github_event.json)
            gh pr comment "$PR_URL" --body "‚úÖ Changelog has been updated automatically"
          else
            echo "Could not find GitHub event data"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
